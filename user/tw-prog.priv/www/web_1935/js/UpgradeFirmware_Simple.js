/* svn info: $Revision: 1114 $ $Date: 2018-09-26 16:59:18 +0800 (Wed, 26 Sep 2018) $ */
top!=self&&(top.location=self.location),null===sessionStorage.getItem("PrivateKey")&&window.location.replace("../info/Login_Simple.html"),$(function(){pageFn.Initial(),pageFn.BtnChange(),currentDevice.featureSingleUpdateForSimpleFirmware&&($("#singleFirmwareInformation").show(),$("#singleFirmwareTable").show(),$("#singleFirmware_hr").show(),$("#singleFW_text").hide(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").show(),$("#singleFW_currentVersion").html(sessionStorage.currentFWVersion),singleFirmwareFn.BtnChange()),"WirelessExtender"!=sessionStorage.currentMode&&"WirelessMeshExtender"!=sessionStorage.currentMode||0!=currentDevice.featureCovrWIFI||($("#extenderMode_system_hr").show(),$("#extenderMode_system_wrap").show())});var pageFn={count:80,getxmlValue_DeviceName:"",SOAP_NAMESPACE:"http://purenetworks.com/HNAP1/",currentFile:"",Initial:function(){initialDetectRouterConnection(),startTimeout();var e=JSON.parse(XMLEncode_forheader(sessionStorage.getItem("modelInfomation")));$("#modelName").html(e.modelName)},BtnChange:function(){var t=this;$("input").on("click",function(){changeTimeoutAction()}),$("button").on("click",function(){changeTimeoutAction()}),$("#manualFirmwareTable2_selectFileBtn").on("click",function(){var e=$.client.browser;$.client.version;"Explorer"==e&&$.client.version<10?alert(I18N("j","The system doesn't support your browser.")):$("#uploadfile").trigger("click")}),$("input[type=file]").on("change",function(e){var n=t.manual_prepareUpload(e);t.manual_ShowUpgradeBtn(n)}),$("#extenderMode_resetBtn").on("click",function(){t.extenderMode_resetBtn()})},do_upgrade:function(){var e=I18N("j","Download New Firmware")+"...";PopView.show(e),this.GetFirmwareValidation().done(function(e){var n=I18N("j","The firmware is being upgraded, please do not power off your device."),t=I18N("j","Firmware Upgrade success!");PopView.showWithPercent(n,e).done(function(){PopView.showConfirm(t).done(function(){location.assign("/")})})}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){location.reload()})})},GetFirmwareValidation:function(){var n=$.Deferred(),e=new SOAPGetFirmwareValidationResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareValidation",null,e).done(function(e){"true"==e.IsValid?n.resolve(parseInt(e.CountDown)):n.reject()}).fail(function(){n.reject()}),n.promise()},manual_prepareUpload:function(e){if(void 0!==e.target){var n=e.target.files;this.currentFile=n[0]}return this.currentFile},manual_ShowUpgradeBtn:function(n){var t=this;$("#manualFirmwareTable2_fileName").show(),$("#manualFirmwareTable2_fileName td p").html(n.name),$("#manualFirmwareTable2_upgrade").show(),$("#manualFirmwareTable2_upgradeBtn").off("click").on("click",function(){var e=I18N("j","Do you want to upgrade Firmware?");PopView.showDialog(e).done(function(){t.manual_upgradeFirmware(n),stopTimeout()}).fail(function(){t.manual_resetFileSelect(),PopView.hide()})})},manual_upgradeFirmware:function(e){var n=this,t=I18N("j","Please wait")+"...";PopView.show(t),n.uploadFile("FirmwareUpload","FWFile",e).done(function(){var e=I18N("j","Please wait")+"...";PopView.show(e),n.manual_upgrade()}).fail(function(){setTimeout(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){n.manual_resetFileSelect(),PopView.hide()})},1e3)})},uploadFile:function(n,t,r){var i=this,o=$.Deferred(),e=new FileReader;return e.onload=function(e){i.upload(n,t,e.target.result,r,0).done(function(){o.resolve()}).fail(function(){o.reject()})},e.readAsArrayBuffer(r),o.promise()},manual_upgrade:function(){var n=this,e=I18N("j","Please wait")+"...";PopView.show(e),n.GetFirmwareValidation().done(function(e){var n=I18N("j","The firmware is being upgraded, please do not power off your device.");PopView.showWithPercent(n,e).done(function(){var e=I18N("j","Firmware Upgrade success!");PopView.showConfirm(e).done(function(){location.assign("/")})})}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){n.manual_resetFileSelect(),PopView.hide()})})},upload:function(e,n,t,r,i){var o=$.Deferred(),a=new Blob([t]),s=new FormData,l={};s.append(n,a,r.name);var c='"'+this.SOAP_NAMESPACE+e+'"';l={SOAPAction:c};var u=sessionStorage.getItem("PrivateKey");if(null!=u){var w=sessionStorage.getItem("Cookie");$.cookie("uid",w,{expires:1,path:"/"});var d=(new Date).getTime();d=(d=Math.floor(d)%2e12).toString();var f=hex_hmac_md5(u,d+c);f=f.toUpperCase()+" "+d,l.HNAP_AUTH=f}return $.ajax({url:"/HNAP1/",type:"POST",data:s,cache:!1,processData:!1,headers:l,contentType:!1,success:function(e,n,t){void 0===e.error?o.resolve():o.reject()},error:function(e,n,t){401==e.status&&location.assign("/"),o.reject()}}),o.promise()},manual_resetFileSelect:function(){$("#manualFirmwareTable2_fileName td p").html(""),$("#uploadfile").val(""),$("#manualFirmwareTable2_fileName").hide(),$("#manualFirmwareTable2_upgrade").hide()},extenderMode_resetBtn:function(){var e=new SOAPAction,n=I18N("j","Are you sure you want to reset the device to its factory default settings? This will cause current settings to be lost."),t=I18N("j","Please wait")+"...",r=I18N("j","Rebooting"),i=I18N("j","Restore to factory default success!"),o=currentDevice.systemCountdown;PopView.showDialog(n,!0).done(function(){PopView.show(t),e.sendSOAPAction("SetFactoryDefault",null,null).done(function(e){PopView.showWithCountdown(r,o).always(function(){PopView.showConfirm(i).done(function(){currentDevice.featureCovrWIFI?self.location.href="http://covr.local./":self.location.href="http://dlinkrouter.local./"})})})}).fail(function(){PopView.hide()})}},singleFirmwareFn={BtnChange:function(){var e=this;$("#singleFirmwareTableMessage_checkNewFirmwareBtn").on("click",function(){$("#singleFW_text span").html(I18N("j","Please wait")+"..."),$("#singleFW_text").show(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").addClass("active").prop("disabled",!0),e.GetFirmwareStatus().done(function(e){var n=e.CurrentFWVersion,t=e.LatestFWVersion;parseFloat(n)<parseFloat(t)?($("#singleFW_latestVersion_tr").show(),$("#singleFW_latestDate_tr").show(),$("#singleFW_latestVersion span").html(t),$("#singleFW_latestDate span").html(e.LatestFWVersionDate),$("#singleFW_text").hide(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").hide(),$("#singleFirmwareTableMessage_upgradeFirmwareBtn").show()):($("#singleFW_latestVersion_tr").hide(),$("#singleFW_latestDate_tr").hide(),$("#singleFW_text span").html(I18N("j","This firmware is the latest version.")),$("#singleFW_text").show()),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").removeClass("active").prop("disabled",!1)}).fail(function(){$("#singleFW_latestVersion_tr").hide(),$("#singleFW_latestDate_tr").hide(),$("#singleFW_text span").html(I18N("j","This firmware is the latest version.")),$("#singleFW_text").show(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").removeClass("active").prop("disabled",!1)})}),$("#singleFirmwareTableMessage_upgradeFirmwareBtn").on("click",function(){stopTimeout(),e.AutoUpgradeFirmware()})},checkFirmware:function(){var n=$.Deferred(),e=new SOAPGetFirmwareSettingsResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareSettings",null,e).done(function(e){n.resolve(e)}).fail(function(){n.reject()}),n.promise()},GetFirmwareStatus:function(){var n=$.Deferred(),e=new SOAPGetFirmwareStatusResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareStatus",null,e).done(function(e){n.resolve(e)}).fail(function(){n.reject()}),n.promise()},AutoUpgradeFirmware:function(){var e=this;PopView.showcount(I18N("j","Please do not close the browser while the firmware is being downloaded!"),""),e.StartFirmwareDownload().progress(function(e){$("#popalert_countdown").html(e+" %")}).done(function(){$("#popalert_countdown").html("100 %"),setTimeout(function(){e.do_upgrade()},2e3)}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){location.reload()})})},StartFirmwareDownload:function(){var n=this,t=$.Deferred();return(new SOAPAction).sendSOAPAction("StartFirmwareDownload",null,null).done(function(e){"OK"==e.StartFirmwareDownloadResult||"RESTART"==e.StartFirmwareDownloadResult?n.GetPollingFirmwareDownloadStatus(3e3).progress(function(e){t.notify(e)}).done(function(){t.resolve()}).fail(function(){t.reject()}):t.reject()}).fail(function(){t.reject()}),t.promise()},GetPollingFirmwareDownloadStatus:function(e){var t=$.Deferred(),n=new SOAPPollingFirmwareDownloadResponse,r=new SOAPAction,i=null,o=null;return 0<e?(i=setInterval(function(){r.sendSOAPAction("PollingFirmwareDownload",null,n).done(function(e){var n=parseInt(e.DownloadPercentage);n<100?t.notify(n):(clearInterval(i),clearInterval(o),t.resolve())})},e),o=setTimeout(function(){clearInterval(i),t.reject()},18e4)):(clearInterval(i),clearInterval(o),t.resolve()),t.promise()},do_upgrade:function(){var e=I18N("j","Please wait")+" ...";PopView.show(e),this.GetFirmwareValidation().done(function(e){var n=I18N("j","The firmware is being upgraded, please do not power off your device."),t=I18N("j","Firmware Upgrade success!");PopView.showWithPercent(n,e).done(function(){PopView.showConfirm(t).done(function(){location.assign("/")})})}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){location.reload()})})},GetFirmwareValidation:function(){var n=$.Deferred(),e=new SOAPGetFirmwareValidationResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareValidation",null,e).done(function(e){"true"==e.IsValid?n.resolve(parseInt(e.CountDown)):n.reject()}).fail(function(){n.reject()}),n.promise()}};