/* svn info: $Revision: 997 $ $Date: 2018-08-03 18:12:24 +0800 (Fri, 03 Aug 2018) $ */
define(["wizPath/wizardViewController","wizPath/wizardModel","wizPath/wizardView","wizPath/wizSiteSurveyView"],function(e,i,r,o){var a,t,n,c,l,s=!1,u=null,d=[],S=null;function h(e){return a=$.Deferred(),t=e,$("#wizard_title").html(I18N("j","Install")+": "+I18N("j","Select a Wi-Fi network to extend")),$("#RTToDUTRight").attr("src","image/wireless_on.gif"),$("#RTToDUTLeft").attr("src","image/wireless_on_180.gif"),$("#wizard4_refreshBtn").off("vclick").on("vclick",function(){d=[],p()}),$("#closeWizBtn").off("vclick").on("vclick",function(){!function(){n.stop(),c&&c.stop();s=!0,a.reject()}()}),$("#wizButton_back").off("click").on("click",function(){0==d.length?a.resolve("back"):w()}),$("#Wizard4").show(),w(),a.promise()}function w(){var e=d.pop();"pwd"==e?v(u):"survey"==e?z(l):p()}function f(){$("#Wizard4SiteSurveySection, #wizard4_scan, #wizard4_survey_result, #Wizard4ManualSection, #wizard4_APValid").hide(),r.initView()}function p(){f(),n=CreateSpinnerObj("SurveySpinner",opts),$("#wizard4_scan_text").html(I18N("j","Scanning...")),$("#Wizard4SiteSurveySection").show(),$("#wizButton_back").hide(),$("#wizButton_next").hide(),$("#wizard4_scan").show(),doSiteSurvey().done(function(e){s||z(l=e)})}function z(e){f(),$("#wizButton_back").show(),$("#wizButton_next").show().html(I18N("j","Manual")).off("click").on("click",function(){d.push("survey"),v(u=null)}),$("#Wizard4SiteSurveySection").show(),$("#wizard4_survey_result").show();var i=$("#SurveyListTable");for(var t in i.html(""),e){var n=e[t],r='<button type="button" class="list-group-item">'+HTMLEncode(n.SSID);r+='<span class="stationInfo">',r+=g(n.SupportedSecurity.SecurityInfo[0].SecurityType),r+=W(parseInt(n.SignalStrength)),r+="</span></button>";var a=$(r);_(a,n),i.append(a)}o.initView()}function _(e,i){e.on("vclick",function(e){e.preventDefault(),changeTimeoutAction(),function(e){t.apcSSID=e.SSID,d.push("survey"),(null==u||u.SSID!=e.SSID)&&$("#Wizard4_Key").val("");"NONE"!=(u=e).SupportedSecurity.SecurityInfo[0].SecurityType.toUpperCase()?v(e):(I(),currentDevice.featureCloseWizExtendedWifi_e?a.resolve("pwd"):a.resolve("wifi"))}(i)})}function v(e){f(),$("#wizButton_next").show().html(I18N("j","Next")).off("click").on("click",function(){$("#Wizard4_form").submit()}),$("#wizButton_back").show(),$("#Wizard4ManualSection").show(),null!=e?($("#Wizard4Manual_desc").html(I18N("j","Please enter the Wi-Fi password for your existing Wi-Fi network")),$("#Wizard4_autoSSID").html(HTMLEncode(e.SSID)).show(),$("#Wizard4_SSID").hide(),0==isTouch()&&$("#Wizard4_Key").focus()):($("#Wizard4Manual_desc").html(I18N("j","Please enter Wireless Network Name, Security and Password of the existing Wi-Fi network.")),$("#Wizard4_SSID").show(),$("#Wizard4_autoSSID").hide(),$("#Wizard4_Key").val(""),0==isTouch()&&$("#Wizard4_SSID").focus()),function(){null!=S&&S.resetForm();$.validator.addMethod("checkASCIIChar",function(e,i){return!!(e.length=0)||CheckASCII(e)},I18N("j","Text field contains illegal characters.")),$.validator.addMethod("checkWPAPassword",function(e,i){return null!=u?e.length<=64&&8<=e.length:0==e.length||e.length<=64&&8<=e.length},I18N("j","The password must be at least 8 characters long.")),$.validator.addMethod("checkssid",function(e,i){return""!=e},I18N("j","Please enter a Wi-Fi Name(SSID).")),S=$("#Wizard4_form").validate({rules:{Wizard4_SSID:{checkssid:!0},Wizard4_Key:{checkASCIIChar:!0,checkWPAPassword:!0}},submitHandler:function(e){return function n(e){r.lockBtn($("#wizButton_next"));r.lockBtn($("#wizButton_back"));r.lockBtn($("#Wizard4_Key"));r.lockBtn($("#Wizard4_SSID"));$("#Wizard4ManualSection").hide();$("#wizard4_APValid").show();null==e&&(c=CreateSpinnerObj("ValidSpinner",opts));var i=new SOAPAction;var t=new SOAPSetTriggerAPValidate;u?(t.RadioID=u.radioID,t.SSID=u.SSID,t.Channel=u.Channel):t.SSID=$("#Wizard4_SSID").val();e&&(t.Enabled=!1);t.Key=$("#Wizard4_Key").val();i.sendSOAPAction("SetTriggerAPValidate",t,null).done(function(e){if("OK_VALIDATED"==e.SetTriggerAPValidateResult)r.unlockBtn($(".form-control")),r.unlockBtn($(".btn-step")),c.stop(),$("#wizard4_APValid").hide(),d.push("pwd"),I(),currentDevice.featureCloseWizExtendedWifi_e?a.resolve("pwd"):a.resolve("wifi");else if(0<=e.SetTriggerAPValidateResult.indexOf("OK_DETECTING")){var i,t=e.SetTriggerAPValidateResult.split("_");void 0!==t[2]&&(i=parseInt(t[2]),1==isNaN(i)&&(i=2)),setTimeout(function(){n("true")},1e3*i)}else r.unlockBtn($(".form-control")),r.unlockBtn($(".btn-step")),c.stop(),$("#wizard4_APValid").hide(),$("#Wizard4ManualSection").show(),$("#Wizard4_Key").addClass("error"),$("#Wizard4_Key_ErrorMessage").html(I18N("j","Invalid password, please try again.")).show()})}(),!1},skipBr:function(e){var i=e.parent("div");return 0!=i.length}})}()}function I(){null==u&&(t.apcSSID=$("#Wizard4_SSID").val()),t.apcPWD=$("#Wizard4_Key").val(),currentDevice.featureCloseWizExtendedWifi_e&&(t.apSSID=t.apcSSID,t.apPWD=t.apcPWD)}function g(e){var i="";return"NONE"!=e.toUpperCase()&&(i="<img src='image/wisp_security.png' width='15' height='21' />"),i}function W(e){var i="";return e<=35?i="wisp_strength_low.png":35<e&&e<=70?i="wisp_strength_medium.png":70<e&&(i="wisp_strength_high.png"),"<img src='image/"+i+"' width='25' height='20' />"}return{init:function(e){return h(e)}}});