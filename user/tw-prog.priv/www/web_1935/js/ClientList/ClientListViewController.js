/* svn info: $Revision: 847 $ $Date: 2018-06-06 18:37:11 +0800 (Wed, 06 Jun 2018) $ */
function LoadMACList(){$.ajax({url:"/js/MacList.json",type:"GET",dataType:"json",success:function(e){macList=e}})}function Base92(e){function t(e){return e+35==92?"!":String.fromCharCode(e+35)}var n=Math.floor(e/92),i=e%92,s="";return s+=92<=n?Base92(n):t(n),s+=t(i)}function getVendor(e){var t,n="Unknown Vendor";if("undefined"==typeof macList||""==macList)return n;try{var i=e.split(":"),s=Base92(parseInt(i[0],16)),a=Base92(parseInt(i[1]+i[2],16));void 0===(t=macList[s][a])&&(t=n)}catch(e){t=n}return decode_char_text(t)}require.config({paths:{Websocket:"/js/SOAP/Websocket"}}),require(["Data","Datalist","ClientListView","QoSViewController","Websocket"],function(o,e,t,r,n){var _=new e,h=new t,d=!0,u="",v="Host";var i=function(e){e.register({Command:"GetAllClientList"},s,null),e.register({Command:"GetClientList",Action:"start"},s,null)},s=function(e,t){for(var n in e.ClientInfo){var i=e.ClientInfo[n];if("delete"==i.Action.toLowerCase()){var s=_.getDataRowNumByMac(i.MacAddress);h.deleteClientHTML(_.list[s]),_.list.splice(s,1)}else{var a=new o(i.MacAddress,i.IPv4Address,i.IPv6Address,i.Type,i.DeviceName,decode_char_text(i.NickName),i.ReserveIP);a.DeviceType=i.DeviceType,a.SignalStrength=i.SignalStrength,null!=(s=_.getDataRowNumByMac(i.MacAddress))?_.editData(_.list[s].rowid,a):_.push(a)}}var l,r;(l=$.Deferred(),r=new SOAPGetMACFilters2Response,soapAction.sendSOAPAction("GetMACFilters2",null,r).done(function(){var e=!1;for(var t in _.prepareUpdate(),_.list){var n=_.list[t];"Blocked"!=n.Type&&(n.Live=!0)}for(var i in r.MACList.MACInfo){var s=r.MACList.MACInfo[i],a=_.getDataRowNumByMac(s.MacAddress);if(null!=a)_.list[a].MacfilterEnabled=!0,_.list[a].ScheduleName=decode_char_text(s.ScheduleName),"false"==s.Status&&(_.list[a].Status=!0,_.list[a].Type="Blocked",e=!0),_.list[a].Live=!0;else{var c=new o(s.MacAddress,"","","Blocked",decode_char_text(s.DeviceName),"","");c.MacfilterEnabled=!0,c.ScheduleName=decode_char_text(s.ScheduleName),"true"==s.Status&&(c.Status=!0),_.push(c),e=!0}}_.clean(),showClientTypeBtn("block",e),l.resolve()}),l.promise()).done(function(){f(),$("#Total_ConnectedClients").html(_.connectedLength)})},a=function(e){i(e)};function c(e){v!=e&&(h.lineList.splice(0,h.lineList.length),$("#client_items").html(""),"Host"==e?($("#client_btn_Blocked").attr("class","v4v6_linkstyle_2"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_2"),$("#client_btn_Host").attr("class","v4v6_linkstyle_1")):("Guest"==e?($("#client_btn_Blocked").attr("class","v4v6_linkstyle_2"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_1")):($("#client_btn_Blocked").attr("class","v4v6_linkstyle_1"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_2")),$("#client_btn_Host").attr("class","v4v6_linkstyle_2")),v=e,f())}function f(){var e,t,n=!1;for(var i in h.prepareUpdate(),_.list){var s=_.list[i],a=(e=s.Type,t=void 0,t="Host",0<e.toLowerCase().indexOf("guest")?t="Guest":"blocked"==e.toLowerCase()&&(t="Blocked"),t),c=h.getClientView(s);a==v&&(null!=c?(h.updateClientHTML(c,s),c.Live=!0):(A(s),n=!0))}var l=h.clean();(n||l)&&"Host"==v&&(h.refreshView(),function(){$(".client_add_Tag").remove();for(var e=h.generateNewHTML(),t=null,n=0;n<h.lineList.length;n++)if(h.lineList[n].objList.length<h.lineList[n].MaxCount){t=h.lineList[n];break}null==t&&(t=h.createLine());e.DOM.appendTo(t.DOM),e.DOM.on("click",function(){h.showAddData(),d=!1,u=""})}())}function A(t){var e=h.generateClientHTML(t);e.MacAddress=t.MacAddress;for(var n=null,i=0;i<h.lineList.length;i++)if(h.lineList[i].objList.length<h.lineList[i].MaxCount){n=h.lineList[i];break}null==n&&(n=h.createLine()),n.push(e),e.DOM.appendTo(n.DOM),e.DOM.on("click",function(){!function(e,t){var n=e.line;for(var i in h.lineList){var s=h.lineList[i];for(var a in s.objList)null!=s.objList[a].qosViewController&&s.objList[a].qosViewController.hideQoS(),e==s.objList[a]&&(l=a)}if(n.QoSShowStatus==e)n.QoSShowStatus=null;else{var c=new r(n.DOM,t);c.showQoS(t,l),e.qosViewController=c,n.QoSShowStatus=e;var l=c.qosView.DOM.offset().top-130;setTimeout(function(){$("html, body").scrollTop(l)},500)}}(e,t)}),e.DOM.find(".client_EditImage").off("click").click(function(e){e.stopPropagation(),h.showEditData(t),d=!0,u=t.rowid})}function l(){var e=!0;changeTimeoutAction(),1==d||(""==$("#client_editMac").val()&&(e=!1),0==$("#enableReserveIP").prop("checked")&&0==$("#enableAccess").prop("checked")&&(e=!1)),1==$("#enableReserveIP").prop("checked")&&""==$("#client_IPAdrReserve").val()&&(e=!1),e?$("#check_btn").attr("class","styled_button_s").prop("disabled",!1):$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0)}LoadMACList(),$("#enableReserveIP").on("change",function(e){l(),$(this).prop("checked")?$("#show_IPAdrReserve").show():$("#show_IPAdrReserve").hide()}),$("#enableAccess").on("change",function(e){l(),$(this).prop("checked")?$("#show_Schedule").show():$("#show_Schedule").hide()}),$("select").change(function(){l()}),$("input").keydown(function(){changeTimeoutAction()}),$("#client_form  input").keyup(function(){l()}),$("#client_btn_Host").off("click").click(function(){c("Host")}),$("#client_btn_Guest").off("click").click(function(){c("Guest")}),$("#client_btn_Blocked").off("click").click(function(){c("Blocked")}),$.validator.addMethod("checkIP",function(e,t){return""==e||!(!COMM_ValidV4Format(e)||!COMM_ValidV4Addr(e))},jQuery.validator.messages.address_Check),$.validator.addMethod("checkMac",function(e,t){return 0!=COMM_IsMAC(e)},jQuery.validator.messages.mac_Check),$.validator.addMethod("checkMacConflict",function(e,t){for(var n in _.list){var i=_.list[n];if(i.MacAddress.toLowerCase()==e.toLowerCase())return!1}return!0},jQuery.validator.messages.mac_Conflict),$.validator.addMethod("checkIPConflict",function(e,t){for(var n in _.list){var i=_.list[n];if((1!=d||u!=i.rowid)&&""!=e&&i.ReserveIP==e)return!1}return!0},jQuery.validator.messages.ip_Conflict),$("#client_form").validate({rules:{client_editMac:{checkMac:!0,checkMacConflict:!0},client_IPAdrReserve:{checkIP:!0,checkIPConflict:!0}},submitHandler:function(e){changeTimeoutAction(),1==d?function(){changeTimeoutAction();var e=$("#enableReserveIP").prop("checked"),t=$("#client_IPAdrReserve").val(),n=$("#client_Name").val(),i=$("#enableAccess").prop("checked"),s=$("#schedule").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0);var a=_.getData(u);a.NickName=n,a.ReserveIP=e&&""!=t?t:"",a.MacfilterEnabled=i,a.ScheduleName=i?s:"",_.editData(a.rowid,a);var c=new SOAPAction,l=new SOAPSetClientInfo,r=new SOAPClientInfo;r.MacAddress=a.MacAddress,r.NickName=encode_char_text(a.NickName),r.ReserveIP=a.ReserveIP,l.ClientInfoLists.push(r),c.sendSOAPAction("SetClientInfo",l,null).done(function(e){if("ERROR_RESERVEIP_CONFLICT"==e.SetClientInfoResult)alert(I18N("j","IP address cannot be the same.")),$("#check_btn").attr("class","styled_button_s").prop("disabled",!1);else{var t=new SOAPAction,n=new SOAPSetMACFilters2;for(var i in _.list)if(_.list[i].MacfilterEnabled){var s=new SOAPMacInfo;s.DeviceName=encode_char_text(_.list[i].NickName),s.MacAddress=_.list[i].MacAddress,s.ScheduleName=encode_char_text(_.list[i].ScheduleName),n.MACList.push(s)}t.sendSOAPAction("SetMACFilters2",n,null),h.resetRulePOP()}})}():function(){changeTimeoutAction();var e=$("#enableReserveIP").prop("checked"),t=$("#client_IPAdrReserve").val(),n=$("#client_Name").val(),i=$("#enableAccess").prop("checked"),s=$("#schedule").val(),a=$("#client_editMac").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0);var c=new SOAPAction,l=null,r=null;if(e){var o=new SOAPSetClientInfo;(v=new SOAPClientInfo).MacAddress=a,v.NickName=encode_char_text(n),v.ReserveIP=t,o.ClientInfoLists.push(v),(l=c.sendSOAPAction("SetClientInfo",o,null)).done(function(e){"ERROR_RESERVEIP_CONFLICT"==e.SetClientInfoResult&&(alert(I18N("j","IP address cannot be the same.")),$("#check_btn").attr("class","styled_button_s").prop("disabled",!1))})}if(i){var d=new SOAPSetMACFilters2;for(var u in _.list){var v;_.list[u].MacfilterEnabled&&((v=new SOAPMacInfo).DeviceName=_.list[u].DeviceName,v.MacAddress=_.list[u].MacAddress,v.ScheduleName=encode_char_text(_.list[u].ScheduleName),d.MACList.push(v))}var f=new SOAPMacInfo;f.DeviceName=encode_char_text(n),f.MacAddress=a,f.ScheduleName=encode_char_text(s),d.MACList.push(f),r=c.sendSOAPAction("SetMACFilters2",d,null)}$.when(l,r).done(function(e){h.resetRulePOP()})}()},unhighlight:function(e,t,n){if($(e).removeClass(t).addClass(n),e==$("input#client_IPAdrReserve")[0]&&1==d){$("#client_IPAdrReserve_warning").remove();var i=_.getData(u);e.value&&e.value!=i.ReserveIP&&($(e).after("<div id='client_IPAdrReserve_warning' style='color:#00f;fone-size:12px' />"),$("#client_IPAdrReserve_warning").html(I18N("j","It will take effect after reconnecting")))}},highlight:function(e,t,n){$(e).addClass(t).removeClass(n),e==$("input#client_IPAdrReserve")[0]&&$("#client_IPAdrReserve_warning").remove()},errorPlacement:function(e,t){e.insertAfter(t).css("display","inline")}}),initWebsocket(n).done(function(e){e.errorHandler=a,i(e)})});