/* svn info: $Revision: 1449 $ $Date: 2019-05-10 21:23:01 +0800 (Fri, 10 May 2019) $ */
var RadioIDList,wifi_datalist=new Array,channelWidthSupport={band24:{},band5:{},band52:{}},channelWidthInfoListsSupport={band24:{},band5:{},band52:{}},scheduleList=[];function WiFiSetting(e,t,n){this.band=e,this.setting=t,this.security=n}function getWiFiData(e,t){for(obj in e)if(t==e[obj].band)return e[obj];return null}function RadioIDToBand(e){var t=null;switch(e){case"RADIO_2.4GHz":t="24";break;case"RADIO_5GHz":t="5"}return t}function GetWirelessXML(){var n=$.Deferred(),i=[null,null];return InitInfo().done(function(){for(var e in RadioIDList){var t=RadioIDList[e];i[e]=get_wireless(t).then(function(e){wifi_datalist.push(e)})}$.when(i[0],i[1]).done(function(){n.resolve(wifi_datalist)})}).fail(function(){n.reject()}),n.promise()}function InitInfo(){var c=$.Deferred(),e=new SOAPAction,S=new SOAPGetWLanRadiosResponse,t=e.sendSOAPAction("GetWLanRadios",null,S);return $.when(t).done(function(){for(var e in RadioIDList=new Array,S.RadioInfos.RadioInfo){var t=S.RadioInfos.RadioInfo[e],n=RadioIDToBand(t.RadioID);RadioIDList.push(t.RadioID);for(var i=0;i<t.ChannelWidthInfoLists.ChannelWidthInfo.length;i++)for(var o=0;o<t.ChannelWidthInfoLists.ChannelWidthInfo[i].ChannelLists.length;o++){var r=channelWidthInfoListsSupport["band"+n],a=t.ChannelWidthInfoLists.ChannelWidthInfo[i].ChannelLists[o];null==r[a]&&(r[a]=new Array),r[a].push(t.ChannelWidthInfoLists.ChannelWidthInfo[i].ChannelWidth)}for(var s in t.ChannelWidthInfoLists.ChannelWidthInfo)channelWidthSupport["band"+n][t.ChannelWidthInfoLists.ChannelWidthInfo[s].ChannelWidth]=!1;"function"==typeof initChannel&&initChannel(t,n)}c.resolve()}).fail(function(){c.reject()}),c.promise()}function getSmartConnectStatus(){var t=$.Deferred(),e=new SOAPGetSmartconnectSettingsResponse;return(new SOAPAction).sendSOAPAction("GetSmartconnectSettings",null,e).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()}function get_wireless(e){var n=$.Deferred(),t=new SOAPAction,i=new SOAPGetWLanRadioSettings,o=new SOAPGetWLanRadioSecurity,r=new SOAPGetWLanRadioSettingsResponse,a=new SOAPGetWLanRadioSecurityResponse,s=RadioIDToBand(e);i.RadioID=e;var c=t.sendSOAPAction("GetWLanRadioSettings",i,r);o.RadioID=e;var S=t.sendSOAPAction("GetWLanRadioSecurity",o,a);return $.when(c,S).done(function(e){var t=new WiFiSetting(s,r,a);n.resolve(t)}).fail(function(e){n.reject()}),n.promise()}function getOPmode(){var t=$.Deferred(),e=new SOAPAction,n=new SOAPGetOperationModeResponse;return e.sendSOAPAction("GetOperationMode",null,n).done(function(e){t.resolve(e)}).fail(function(e){t.reject()}),t.promise()}function getAPCsettings(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPGetAPClientSettings,o=new SOAPGetAPClientSettingsResponse;return i.RadioID=e,n.sendSOAPAction("GetAPClientSettings",i,o).done(function(e){"true"==e.Enabled.toLowerCase()&&""!=e.SSID?t.resolve(e):t.reject(e)}).fail(function(e){t.reject()}),t.promise()}function getAPCinfoByRadio(e,t){var n=$.Deferred(),i=t;return getAPCsettings(e[i]).done(function(e){n.resolve(e)}).fail(function(){++i<e.length?getAPCinfoByRadio(e,i).done(function(e){n.resolve(e)}).fail(function(){n.reject()}):n.reject()}),n.promise()}function getAPCinfo(e){var t=$.Deferred();return getAPCinfoByRadio(e,0).done(function(e){t.resolve(e)}).fail(function(){var e=new SOAPGetAPClientSettingsResponse;t.resolve(e)}),t.promise()}function createWlanSettings(e){var t=new SOAPSetWLanRadioSettings,n=getWiFiData(wifi_datalist,e),i=$("#CurrentOPMode").val(),o=$("#APenabled_Smart").prop("checked");switch(e){case"24":t.RadioID="RADIO_2.4GHz",t.Coexistence=$("#APcoexistence_"+e).prop("checked"),t.Mode="802.11bgn";break;case"5":t.RadioID="RADIO_5GHz",t.Mode="802.11anac",t.Coexistence=n.setting.Coexistence}return o?(t.Enabled=$("#APenabled_24").prop("checked"),t.SSID=XMLEncode($("#APssid_24").val()),t.ChannelWidth=0,t.Channel=0):(t.Enabled=$("#APenabled_"+e).prop("checked"),t.SSID=XMLEncode($("#APssid_"+e).val()),"WirelessAp"==i?(t.ChannelWidth=$("#APchannelWidth_"+e).val(),t.Channel=$("#APchannel_"+e).val()):(t.ChannelWidth=n.setting.ChannelWidth,t.Channel=n.setting.Channel)),t.SSIDBroadcast=n.setting.SSIDBroadcast,t.QoS=n.setting.QoS,currentDevice.scheduleAndWiFi_ea?currentDevice.featureWirelessSchedule?t.ScheduleName=o?$('input[name="scheduleRadio_24"]:checked').val():$('input[name="scheduleRadio_'+e+'"]:checked').val():t.ScheduleName=o?$("#schedule_24").val():$("#schedule_"+e).val():t.ScheduleName=n.setting.ScheduleName,t.TXPower=n.setting.TXPower,t.MUMIMOEnabled=n.setting.MUMIMOEnabled,t.BandSteeringEnabled=n.setting.BandSteeringEnabled,t.AirTimeFairnessEnabled=n.setting.AirTimeFairnessEnabled,t}function createWlanSecurity(e){var t=new SOAPSetWLanRadioSecurity,n=$("#APenabled_Smart").prop("checked"),i=$("#APkey_"+e).val();switch(n&&(i=$("#APkey_24").val()),e){case"24":t.RadioID="RADIO_2.4GHz";break;case"5":t.RadioID="RADIO_5GHz"}return 0==i.length?(t.Enabled=!1,t.Type="NONE",t.Encryption="NONE"):(t.Enabled=!0,t.Type="WPAORWPA2-PSK",t.Encryption="TKIPORAES",t.Key=i,t.KeyRenewal=3600),t}function createOPmode(e,t){var n=new SOAPSetOperationMode;return n.RadioID=e,n.CurrentOPMode=t,n}function createAPCSettings(e,t){var n=XMLEncode(e),i=t,o=new SOAPSetAPClientSettings;return o.RadioID="",o.SSID=n,o.Enabled=!0,0==(o.Key=i).length?(o.SupportedSecurity.SecurityInfo[0].SecurityType="NONE",o.SupportedSecurity.SecurityInfo[0].Encryptions=["NONE"]):(o.SupportedSecurity.SecurityInfo[0].SecurityType="WPAORWPA2-PSK",o.SupportedSecurity.SecurityInfo[0].Encryptions=["TKIPORAES"]),o}function SetWirelessXML(){var e,t,n=$.Deferred(),i=new SOAPAction,o=$("#CurrentOPMode").val();for(var r in RadioIDList){e=createOPmode(RadioIDList[r],o),i.SetMultipleSOAP("SetOperationMode",e,null)}if("WirelessAp"!=o&&(e=createAPCSettings($("#APCssid").val(),$("#APCkey").val()),i.SetMultipleSOAP("SetAPClientSettings",e,null),count=80),setSmartConnectStatus(i,$("#APenabled_Smart").prop("checked")),currentDevice.featureWirelessSchedule){var a=spDropDownListDatalist.setScheduleXML(),s="SetScheduleSettings";currentDevice.featureBitMapSchedule&&(s="SetScheduleBitmapSettings"),i.SetMultipleSOAP(s,a,null)}for(var r in RadioIDList){var c=RadioIDToBand(RadioIDList[r]);e=createWlanSettings(c),i.SetMultipleSOAP("SetWLanRadioSettings",e,null),t=createWlanSecurity(c),i.SetMultipleSOAP("SetWLanRadioSecurity",t,null)}return i.SendMultipleSOAPAction("SetMultipleActions").done(function(){n.resolve()}),n.promise()}function setSmartConnectStatus(e,t){var n=new SOAPSetSmartconnectSettings;n.Enabled=t,e.SetMultipleSOAP("SetSmartconnectSettings",n,null)}function startWPSPBC(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPSetTriggerWPS,o=new SOAPSetTriggerWPSResponse;return stopTimeout(),i.Duration=e,n.sendSOAPAction("SetTriggerWPS",i,o).done(function(e){getWPSStatus(1e3*parseInt(e.WaitTime)).progress(function(e){t.notify(e)}).then(function(e){startTimeout(),t.resolve(e)}).fail(function(){t.reject()})}).fail(function(e){t.reject()}),t.promise()}function getWPSStatus(e){var i=$.Deferred(),t=new SOAPAction,n=new SOAPGetWPSStatusResponse,o=setTimeout(function(){o=setInterval(function(){t.sendSOAPAction("GetWPSStatus",null,n).done(function(e){for(var t in e.WPSStatusLists.WPSStatus){var n=e.WPSStatusLists.WPSStatus[t];if("WPS_IN_PROGRESS"==n.Status.toUpperCase())break;"WPS_SUCCESS"==n.Status.toUpperCase()?(clearInterval(o),i.resolve(n)):(clearInterval(o),i.reject())}}).fail(function(e){clearInterval(o),i.reject()})},2e3),i.notify(o)},e);return i.notify(o),i.promise()}function getSiteSurveyResult(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPGetSiteSurvey,o=new SOAPGetSiteSurveyResponse;return i.RadioID=e,n.sendSOAPAction("GetSiteSurvey",i,o).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()}function doSiteSurveyByRadio(i,e){var o=$.Deferred(),r=e,t=new SOAPAction,n=new SOAPSetTriggerWirelessSiteSurvey,a=new SOAPSetTriggerWirelessSiteSurveyResponse;n.RadioID=i[r],t.sendSOAPAction("SetTriggerWirelessSiteSurvey",n,a).done(function(e){var t=parseInt(e.WaitTime);sleep(1e3*t).then(function(){return getSiteSurveyResult(i[r])}).then(function(e){var t=e.APStatInfoLists.APStatInfo;for(var n in t)t[n].radioID=i[r];o.notify(t),s(!0)}).fail(function(){s(!1)})}).fail(function(){o.reject()});var s=function(e){++r<i.length?doSiteSurveyByRadio(i,r).done(function(e){o.resolve()}).progress(function(e){o.notify(e)}).fail(function(){o.reject()}):e?o.resolve():o.reject()};return o.promise()}function sortSiteList(e){e.sort(function(e,t){return parseInt(t.SignalStrength)-parseInt(e.SignalStrength)})}function doSiteSurvey(){var e=$.Deferred(),n=new Array;return stopTimeout(),doSiteSurveyByRadio(RadioIDList,0).progress(function(e){for(var t in e)n.push(e[t])}).always(function(){sortSiteList(n),startTimeout(),e.resolve(n)}),e.promise()}function getschedulesettings(){var e,t=$.Deferred(),n=new SOAPAction,r=new SOAPGetScheduleSettingsResponse,i={page:"wireless",timeFormat:currentDevice.featureScheduleRuleSlotInterval};return currentDevice.featureBitMapSchedule?(r=new SOAPGetScheduleBitmapSettingsResponse,i.hnapName="GetScheduleBitmapSettings",e=n.sendSOAPAction("GetScheduleBitmapSettings",null,r)):e=n.sendSOAPAction("GetScheduleSettings",null,r),currentDevice.featureWirelessSchedule?$.when(e).done(function(){scheduleList.push($("#scheduleDrop_24").spDropDownList({titleWidth:293.328,contextWidth:293.328,elName:"H24-UH1xLTJa7O"})),scheduleList.push($("#scheduleDrop_5").spDropDownList({titleWidth:293.328,contextWidth:293.328,elName:"H5-UH1xLTJa7O"})),scheduleSelectableUI.init(i).getData(r),t.resolve()}).fail(function(){t.reject()}):$.when(e).done(function(){RadioIDList.map(function(e){var t=RadioIDToBand(e),n=$("#schedule_"+t);for(var i in n.append('<option value="Always">'+I18N("j","Always")+"</option>"),r.ScheduleInfoLists){var o=r.ScheduleInfoLists[i].ScheduleName;n.append('<option value="'+o+'">'+decode_char_text(o)+"</option>")}n.selectbox({width:"100%"})}),t.resolve()}).fail(function(){t.reject()}),t.promise()}