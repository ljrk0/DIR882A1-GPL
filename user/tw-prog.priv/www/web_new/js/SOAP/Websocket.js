/* svn info: $Revision: 847 $ $Date: 2018-06-06 18:37:11 +0800 (Wed, 06 Jun 2018) $ */
var currentWS=null;function initWebsocket(e){var t=$.Deferred();return(null==currentWS?new e:currentWS).connect().done(function(e){t.resolve(e)}),t.promise()}define("Websocket",function(){function e(){this.socket=null,this.delegateList={},this.errorHandler=null,(currentWS=this).keepAliveTimer=null,this.alive=!0}var i=500;return e.prototype.connect=function(){var r=$.Deferred(),o=this,n=!1;if(null!=this.socket)return r.resolve(this);var e="ws://"+location.host;return""!=location.port&&(e+=":"+location.port),this.socket=new WebSocket(e+"/WebSocketService","WebSocketService"),o.socket.onopen=function(){var e=sessionStorage.getItem("Cookie"),t=sessionStorage.getItem("PrivateKey"),r=(new Date).getTime();r=(r=Math.floor(r/1e3)%2e9).toString(),t=(t=hex_hmac_md5(t,r+"http://dlinkrouter.local./WebSocketService")).toUpperCase()+" "+r;o.socket.send(JSON.stringify({Command:"AUTH",HNAP_AUTH:t,Cookie:e})),i=500,null!=o.keepAliveTimer&&clearInterval(o.keepAliveTimer),o.keepAliveTimer=setInterval(function(){o.sendKeepAlive()},6e4)},o.socket.onmessage=function(e){try{var t=JSON.parse(e.data);if("AUTH"==t.Command.toUpperCase()&&"OK"==t.Result.toUpperCase())n=!0,r.resolve(o);else switch(t.Command.toUpperCase()){case"PONG":o.alive=!0;break;default:n&&o.parseMsg(e.data)}}catch(e){}},o.socket.onclose=function(){o.defaultErrorHandler().done(function(){null!=o.errorHandler&&o.errorHandler(o)}),r.reject()},o.socket.onerror=function(){o.defaultErrorHandler().done(function(){null!=o.errorHandler&&o.errorHandler(o)}),r.reject()},r.promise()},e.prototype.register=function(e,t,r){this.delegateList[e.Command]=[t,r],this.socket.send(JSON.stringify(e))},e.prototype.parseMsg=function(e){e=JSON.parse(e);try{var t=this.delegateList[e.Command][0],r=this.delegateList[e.Command][1];void 0!==t&&t(e,r)}catch(e){}},e.prototype.defaultErrorHandler=function(){var e=$.Deferred(),t=this;return clearInterval(this.keepAliveTimer),this.keepAliveTimer=!1,this.socket.close(),this.socket=null,i*=2,setTimeout(function(){t.connect().done(function(){e.resolve(this)})},i),this.delegateList={},e.promise()},e.prototype.sendKeepAlive=function(){var e=this;this.alive=!1,e.socket.send(JSON.stringify({Command:"PING"})),setTimeout(function(){0==e.alive&&e.defaultErrorHandler().done(function(){null!=e.errorHandler&&e.errorHandler(e)})},5e3)},e});