/* svn info: $Revision: 1598 $ $Date: 2019-08-27 10:46:17 +0800 (Tue, 27 Aug 2019) $ */
top!=self&&(top.location=self.location),null===sessionStorage.getItem("PrivateKey")&&window.location.replace("../info/Login_Simple.html"),$(function(){pageFn.Initial(),pageFn.BtnChange(),currentDevice.featureSingleUpdateForSimpleFirmware&&($("#singleFirmwareInformation").show(),$("#singleFirmwareTable").show(),$("#singleFirmware_hr").show(),$("#singleFW_text").hide(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").show(),$("#singleFW_currentVersion").html(sessionStorage.currentFWVersion)),"WirelessExtender"!=sessionStorage.currentMode&&"WirelessMeshExtender"!=sessionStorage.currentMode||0!=currentDevice.featureCovrWIFI||($("#extenderMode_system_hr").show(),$("#extenderMode_system_wrap").show(),currentDevice.featureAutoUpgrade&&($("body").css("background-image","url(../image/header_addSave.gif?v=dc767c42ed)"),$("#funcBar").show(),$("#rightFunc").show(),$("#AutoFirmwareUpgrade").show(),$("#AutoFirmwareUpgrade_hr").show(),pageFn.GetAutoUpgradeSettings().then(function(){$("#AutoFirmwareUpgrade > table").show()}))),$("#updateFirmwareSimple_form").validate({submitHandler:function(e){return pageFn.CheckConnectionStatus(),!1}})});var pageFn={count:80,getxmlValue_DeviceName:"",SOAP_NAMESPACE:"http://purenetworks.com/HNAP1/",currentFile:"",Initial:function(){initialDetectRouterConnection(),startTimeout();var e=JSON.parse(XMLEncode_forheader(sessionStorage.getItem("modelInfomation")));$("#modelName").html(e.modelName)},BtnChange:function(){var o=this;$("input").on("click",function(){changeTimeoutAction()}),$("button").on("click",function(){changeTimeoutAction()}),$("#manualFirmwareTable2_selectFileBtn").on("click",function(){var e=$.client.browser;$.client.version;"Explorer"==e&&$.client.version<10?alert(I18N("j","The system doesn't support your browser.")):$("#uploadfile").trigger("click")}),$("input[type=file]").on("change",function(e){var t=o.manual_prepareUpload(e);o.manual_ShowUpgradeBtn(t)}),$("#extenderMode_resetBtn").on("click",function(){o.extenderMode_resetBtn()}),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").on("click",function(){$("#singleFW_text span").html(I18N("j","Please wait")+"..."),$("#singleFW_text").show(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").addClass("active").prop("disabled",!0),o.GetFirmwareStatus().done(function(e){var t=e.CurrentFWVersion,n=e.LatestFWVersion;parseFloat(t)<parseFloat(n)?($("#singleFW_latestVersion_tr").show(),$("#singleFW_latestDate_tr").show(),$("#singleFW_latestVersion span").html(n),$("#singleFW_latestDate span").html(e.LatestFWVersionDate),$("#singleFW_text").hide(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").hide(),$("#singleFirmwareTableMessage_upgradeFirmwareBtn").show()):($("#singleFW_latestVersion_tr").hide(),$("#singleFW_latestDate_tr").hide(),$("#singleFW_text span").html(I18N("j","This firmware is the latest version.")),$("#singleFW_text").show()),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").removeClass("active").prop("disabled",!1)}).fail(function(){$("#singleFW_latestVersion_tr").hide(),$("#singleFW_latestDate_tr").hide(),$("#singleFW_text span").html(I18N("j","This firmware is the latest version.")),$("#singleFW_text").show(),$("#singleFirmwareTableMessage_checkNewFirmwareBtn").removeClass("active").prop("disabled",!1)})}),$("#singleFirmwareTableMessage_upgradeFirmwareBtn").on("click",function(){stopTimeout(),o.AutoUpgradeFirmware()}),$("#status_AutoUpgrade").on("click",function(){var e=$("#UpgradeTimeHour"),t=$("#UpgradeTimeMinute"),n=$(this).prop("checked"),a=$("#upgradeTimeTr");n?a.show():(a.hide(),$("#status_PreferUpgradeTime").prop("checked",!1),e.selectbox("disable"),t.selectbox("disable")),o.changeAutoUpgradeMSG(n),$("#Save_Disable_btn").hide(),$("#Save_btn").show(),changeFlag=!0,changeTimeoutAction()}),$("#UpgradeTimeHour, #UpgradeTimeMinute").on("change",function(){$("#Save_Disable_btn").hide(),$("#Save_btn").show(),changeFlag=!0,changeTimeoutAction(),o.updateUpgradeTime=1}),$("#status_PreferUpgradeTime").on("click",function(){$("#Save_Disable_btn").hide(),$("#Save_btn").show();var e=$(this).prop("checked"),t=$("#UpgradeTimeHour"),n=$("#UpgradeTimeMinute");e?(t.selectbox("enable"),n.selectbox("enable")):(t.selectbox("disable"),n.selectbox("disable")),changeFlag=!0,changeTimeoutAction()})},GetFirmwareValidation:function(){var t=$.Deferred(),e=new SOAPGetFirmwareValidationResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareValidation",null,e).done(function(e){"true"==e.IsValid?t.resolve(parseInt(e.CountDown)):t.reject()}).fail(function(){t.reject()}),t.promise()},manual_prepareUpload:function(e){if(void 0!==e.target){var t=e.target.files;this.currentFile=t[0]}return this.currentFile},manual_ShowUpgradeBtn:function(t){var n=this;$("#manualFirmwareTable2_fileName").show(),$("#manualFirmwareTable2_fileName td p").text(t.name),$("#manualFirmwareTable2_upgrade").show(),$("#manualFirmwareTable2_upgradeBtn").off("click").on("click",function(){var e=I18N("j","Do you want to upgrade Firmware?");PopView.showDialog(e).done(function(){n.manual_upgradeFirmware(t),stopTimeout()}).fail(function(){n.manual_resetFileSelect(),PopView.hide()})})},manual_upgradeFirmware:function(e){var t=this,n=I18N("j","Please wait")+"...";PopView.show(n),t.uploadFile("FirmwareUpload","FWFile",e).done(function(){var e=I18N("j","Please wait")+"...";PopView.show(e),t.manual_upgrade()}).fail(function(){setTimeout(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){t.manual_resetFileSelect(),PopView.hide()})},1e3)})},uploadFile:function(t,n,a){var o=this,i=$.Deferred(),e=new FileReader;return e.onload=function(e){o.upload(t,n,e.target.result,a,0).done(function(){i.resolve()}).fail(function(){i.reject()})},e.readAsArrayBuffer(a),i.promise()},manual_upgrade:function(){var t=this,e=I18N("j","Please wait")+"...";PopView.show(e),t.GetFirmwareValidation().done(function(e){var t=I18N("j","The firmware is being upgraded, please do not power off your device.");PopView.showWithPercent(t,e).done(function(){var e=I18N("j","Firmware Upgrade success!");PopView.showConfirm(e).done(function(){location.assign("/")})})}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){t.manual_resetFileSelect(),PopView.hide()})})},upload:function(e,t,n,a,o){var i=$.Deferred(),r=new Blob([n]),l=new FormData,s={};l.append(t,r,a.name);var u='"'+this.SOAP_NAMESPACE+e+'"';s={SOAPAction:u};var c=sessionStorage.getItem("PrivateKey");if(null!=c){var d=sessionStorage.getItem("Cookie");$.cookie("uid",d,{expires:1,path:"/"});var p=(new Date).getTime();p=(p=Math.floor(p)%2e12).toString();var w=hex_hmac_md5(c,p+u);w=w.toUpperCase()+" "+p,s.HNAP_AUTH=w}return $.ajax({url:"/HNAP1/",type:"POST",data:l,cache:!1,processData:!1,headers:s,contentType:!1,success:function(e,t,n){void 0===e.error?i.resolve():i.reject()},error:function(e,t,n){401==e.status&&location.assign("/"),i.reject()}}),i.promise()},manual_resetFileSelect:function(){$("#manualFirmwareTable2_fileName td p").html(""),$("#uploadfile").val(""),$("#manualFirmwareTable2_fileName").hide(),$("#manualFirmwareTable2_upgrade").hide()},extenderMode_resetBtn:function(){var e=new SOAPAction,t=I18N("j","Are you sure you want to reset the device to its factory default settings? This will cause current settings to be lost."),n=I18N("j","Please wait")+"...",a=I18N("j","Rebooting"),o=I18N("j","Restore to factory default success!"),i=currentDevice.systemCountdown;PopView.showDialog(t,!0).done(function(){PopView.show(n),e.sendSOAPAction("SetFactoryDefault",null,null).done(function(e){PopView.showWithCountdown(a,i).always(function(){PopView.showConfirm(o).done(function(){currentDevice.featureCovrWIFI?self.location.href="http://covr.local./":self.location.href="http://dlinkrouter.local./"})})})}).fail(function(){PopView.hide()})},GetFirmwareStatus:function(){var t=$.Deferred(),e=new SOAPGetFirmwareStatusResponse;return(new SOAPAction).sendSOAPAction("GetFirmwareStatus",null,e).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()},AutoUpgradeFirmware:function(){var e=this;PopView.showcount(I18N("j","Please do not close the browser while the firmware is being downloaded!"),""),e.StartFirmwareDownload().progress(function(e){$("#popalert_countdown").html(e+" %")}).done(function(){$("#popalert_countdown").html("100 %"),setTimeout(function(){e.do_upgrade()},2e3)}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){location.reload()})})},StartFirmwareDownload:function(){var t=this,n=$.Deferred();return(new SOAPAction).sendSOAPAction("StartFirmwareDownload",null,null).done(function(e){"OK"==e.StartFirmwareDownloadResult||"RESTART"==e.StartFirmwareDownloadResult?t.GetPollingFirmwareDownloadStatus(3e3).progress(function(e){n.notify(e)}).done(function(){n.resolve()}).fail(function(){n.reject()}):n.reject()}).fail(function(){n.reject()}),n.promise()},GetPollingFirmwareDownloadStatus:function(e){var n=$.Deferred(),t=new SOAPPollingFirmwareDownloadResponse,a=new SOAPAction,o=null,i=null;return 0<e?(o=setInterval(function(){a.sendSOAPAction("PollingFirmwareDownload",null,t).done(function(e){var t=parseInt(e.DownloadPercentage);t<100?n.notify(t):(clearInterval(o),clearInterval(i),n.resolve())})},e),i=setTimeout(function(){clearInterval(o),n.reject()},6e5)):(clearInterval(o),clearInterval(i),n.resolve()),n.promise()},do_upgrade:function(){var e=I18N("j","Please wait")+" ...";PopView.show(e),this.GetFirmwareValidation().done(function(e){var t=I18N("j","The firmware is being upgraded, please do not power off your device."),n=I18N("j","Firmware Upgrade success!");PopView.showWithPercent(t,e).done(function(){PopView.showConfirm(n).done(function(){location.assign("/")})})}).fail(function(){var e=I18N("j","Firmware Upgrade failed!");PopView.showConfirm(e).done(function(){location.reload()})})},GetAutoUpgradeSettings:function(){var l=this,s=$.Deferred(),e=new SOAPAction,u=new SOAPGetFirmwareAutoUpdateResponse;return e.sendSOAPAction("GetFirmwareAutoUpdate",null,u).done(function(){$("select").selectbox("detach");for(var e=document.getElementById("UpgradeTimeHour"),t=document.getElementById("UpgradeTimeMinute"),n=0;n<=23;n++){var a=n;n<12?(0==n&&(a=12),e.options.add(new Option(a+" AM",n))):(a=n-12==0?n:n-12,e.options.add(new Option(a+" PM",n)))}for(n=0;n<=59;n++)n<10?t.options.add(new Option("0"+n,n)):t.options.add(new Option(n,n));var o=u.TimeToUpdate.TimeHourValue,i=u.TimeToUpdate.TimeMinuteValue,r=u.AutoUpdate;e.value=""!=o?o:"3",t.value=""!=i?i:"30",$("select").selectbox({width:100}),$("select").selectbox("attach"),""==o||""==i?($("#UpgradeTimeHour").selectbox("disable"),$("#UpgradeTimeMinute").selectbox("disable")):$("#status_PreferUpgradeTime").prop("checked","true"),"true"==r?($("#status_AutoUpgrade").prop("checked",!0),$("#upgradeTimeTr").show()):($("#status_AutoUpgrade").prop("checked",!1),$("#upgradeTimeTr").hide()),l.changeAutoUpgradeMSG(r),s.resolve()}).fail(function(){s.reject()}),s.promise()},changeAutoUpgradeMSG:function(e){"true"==e.toString()?$("#autoUpgradeText").html(I18N("j","Update my device automatically every day at 3:30-4:00 AM to always enjoy the latest improvements and features.")):$("#autoUpgradeText").html(I18N("j","Update my device automatically to always enjoy the latest improvements and features."))},SetAutoUpgradeSettings:function(){var i=I18N("j","Please wait")+" ...";PopView.show(i);var e=new SOAPAction,t=new SOAPSetFirmwareAutoUpdate,n=new SOAPSetEventNotification,a=$("#status_AutoUpgrade").prop("checked");n.Enabled=a,n.AutoFirmwareUpgrade=a,$("#status_PreferUpgradeTime").prop("checked")?(t.TimeToUpdate.TimeHourValue=$("#UpgradeTimeHour").val(),t.TimeToUpdate.TimeMinuteValue=$("#UpgradeTimeMinute").val()):(delete t.TimeToUpdate.TimeHourValue,delete t.TimeToUpdate.TimeMinuteValue,delete t.TimeToUpdate.TimeMidDateValue),t.AutoDownload=a,t.AutoUpdate=a,e.SetMultipleSOAP("SetEventNotification",n,null),e.SetMultipleSOAP("SetFirmwareAutoUpdate",t,null),e.SendMultipleSOAPAction("SetMultipleActions").done(function(e,t,n){var a=currentDevice.okcount;""!=n&&(a=n);var o=I18N("j","The new settings have been saved.");PopView.showWithCountdown(i,a).always(function(){PopView.showConfirm(o).done(function(){window.location.reload()})})}).fail(function(){window.location.reload()})},CheckConnectionStatus:function(){var t=this;$.ajax({cache:!1,url:"./js/CheckConnection",timeout:2e3,type:"GET",success:function(e){t.SetAutoUpgradeSettings()},error:function(){document.getElementById("DetectRouterConnection").style.display="inline"}})}};