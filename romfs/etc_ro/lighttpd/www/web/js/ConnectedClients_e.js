/* svn info: $Revision: 1225 $ $Date: 2018-12-10 18:50:29 +0800 (Mon, 10 Dec 2018) $ */
function Datalist(){this.list=new Array,this.maxrowid=0;var e=new Data("","","","New","","","","","","");currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e&&this.push(e)}function Data(e,t,i,s,a,n,l,r,c,d){this.MacAddress=e,this.IPv4Address=t,this.IPv6Address=i,this.Type=s,this.DeviceName=a,this.NickName=n,this.ReserveIP=l,this.State=d,this.Vendor=getVendor(e),this.ScheduleName="Always",this.MacfilterEnabled=!1,this.isAllowList=!1,this.isMacfilterEnabled=!0,this.Status=!1,this.ExtenderMacAddress=r,this.SignalStrength=c,this.Live=!0}var tmpXML_ScheduleCnt;Datalist.prototype={get length(){return this.list.length},set length(e){0<=parseInt(e,10)&&(this.list.length=parseInt(e,10))},get connectedLength(){var e=0,t=0;for(var i in currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e&&(t=1),this.list)"Blocked"==this.list[i].Type&&e++,"offline"==this.list[i].Type.toLowerCase()&&t++;return this.list.length-e-t}},Datalist.prototype.prepareUpdate=function(){for(var e in this.list)this.list[e].Live=!1},Datalist.prototype.getData=function(e){var t,i;for(t=0;t<this.list.length&&(i=this.list[t]).rowid!=e;t++);return i},Datalist.prototype.getDataRowNumByMac=function(e){var t,i=null,s=e.toLowerCase();for(t=0;t<this.list.length;t++)if(this.list[t].MacAddress.toLowerCase()==s){i=t;break}return i},Datalist.prototype.getRowNum=function(e){var t=0;for(t=0;t<this.list.length&&e!=this.list[t].rowid;t++);return t},Datalist.prototype.editData=function(e,t){var i=this.list[this.getRowNum(e)];return i.IPv4Address=t.IPv4Address,i.IPv6Address=t.IPv6Address,i.Type=t.Type,i.DeviceName=t.DeviceName,i.NickName=t.NickName,i.ReserveIP=t.ReserveIP,i.Vendor=t.Vendor,i.ScheduleName=t.ScheduleName,i.MacfilterEnabled=t.MacfilterEnabled,i.Status=t.Status,i.isAllowList=t.isAllowList,i.isMacfilterEnabled=t.isMacfilterEnabled,i.Live=!0},Datalist.prototype.deleteData=function(e){var t=this.getRowNum(e);this.list.splice(t,1)},Datalist.prototype.push=function(e){return e.setRowid(this.maxrowid),this.list.push(e),this.maxrowid++,this.list.sort(function(e,t){function i(e){return"LAN"==e?0:0<=e.toUpperCase().indexOf("WIFI_")?1:2}return i(e.Type)-i(t.Type)}),!0},Datalist.prototype.clean=function(){for(var e in this.list)obj=this.list[e],0==obj.Live&&this.list.splice(e,1)},Data.prototype={get NickName(){return""==this._NickName?this.DeviceName:this._NickName},set NickName(e){(this._NickName=e)==this.DeviceName&&(this._NickName="")},get ScheduleName(){return this._ScheduleName},set ScheduleName(e){""==e||"always"==e.toLowerCase()?this._ScheduleName="Always":this._ScheduleName=e},setRowid:function(e){this.rowid=e},showClientInfo:function(){var e,t=this,i=t.NickName,s="",a="link_IconE_",n="client_Name",l=t.IPv4Address,r=t.Vendor;if(void 0===t.MacAddress||0==t.MacAddress.length)return"";""==i&&(i="Unknown");var c,d=t.Type.toUpperCase();return"WIFI_2.4G"==d||"WIFI_2.4G_GUEST"==d?a="link_IconW_":"WIFI_5G"==d||"WIFI_5G_GUEST"==d?a="link_IconW5G_":"OFFLINE"==d&&(a="link_Offline_",n+=" client_Name_Offline",l=t.ReserveIP),t.MacfilterEnabled?(s=I18N("j","Enabled"),e="#FF0000"):(s=I18N("j","Disabled"),e="#000000"),"BLOCKED"==t.State?a+="Block":a+="Allow",c='<td style="height:120px;"><div class ="client_Tag" style ="cursor:default"><div class ="'+a+'"></div><div class ="client_Info"><div class ="'+n+'">'+HTMLEncode(i)+'</div><div class ="client_EditImage" onclick ="editData('+t.rowid+')" style ="cursor:pointer"></div><div class ="client_Vender" title="'+r+'" style="overflow:hidden;text-overflow:ellipsis;width:100px;white-space:nowrap;">'+r+'</div><div class ="client_IPv4Address">'+l+'</div><div class ="client_IPv6Address" id="IPv6Address_Client_'+t.rowid+'" title="'+t.IPv6Address+'">'+t.IPv6Address+"</div>",currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e&&(0<=t.Type.indexOf("WiFi")||"OFFLINE"==t.Type)&&(c+='<div class ="client_Access">'+I18N("j","Parental Control")+': <font color ="'+e+'">'+s+"</font></div>"),c+="</div></div></td>"}};var Client_Type="Host",datalist=new Datalist,macList="",editType=!0,editID="";function extenderGotosettingFn(e){if(null==e)var t="";else{var i=e.split(":");t=i[4]+i[5]}location.href="http://dlinkap"+t+".local./"}function LoadMACList(){$.ajax({url:"/js/MacList.json",type:"GET",dataType:"json",success:function(e){macList=e}})}function Base92(e){function t(e){return e+35==92?"!":String.fromCharCode(e+35)}var i=Math.floor(e/92),s=e%92,a="";return a+=92<=i?Base92(i):t(i),a+=t(s)}function getVendor(e){var t,i="Unknown Vendor";if(void 0===macList||""==macList)return i;try{var s=e.split(":"),a=Base92(parseInt(s[0],16)),n=Base92(parseInt(s[1]+s[2],16));void 0===(t=macList[a][n])&&(t=i)}catch(e){t=i}return decode_char_text(t)}function Get_ClientInfo(){var c=$.Deferred(),d=new SOAPGetClientInfoResponse,o=new SOAPGetMACFilters2Response,e=new SOAPAction,t=e.sendSOAPAction("GetClientInfo",null,d),i=null;return currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e&&(i=e.sendSOAPAction("GetMACFilters2",null,o)),$.when(t,i).done(function(e){for(var t in datalist.prepareUpdate(),datalist.list){"Blocked"==(e=datalist.list[t]).Type&&(e.Live=!0),"New"==e.Type&&(e.Live=!0)}for(var i in d.ClientInfoLists.ClientInfo){var s=d.ClientInfoLists.ClientInfo[i],a=new Data(s.MacAddress,s.IPv4Address,s.IPv6Address,s.Type,s.DeviceName,decode_char_text(s.NickName),s.ReserveIP,s.ExtenderMacAddress,s.SignalStrength,s.State);null!=(l=datalist.getDataRowNumByMac(s.MacAddress))?datalist.editData(datalist.list[l].rowid,a):datalist.push(a)}if(datalist.clean(),currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e){for(var t in datalist.prepareUpdate(),datalist.list){"Blocked"!=(e=datalist.list[t]).Type&&(e.Live=!0)}for(var n in datalist.isAllowList=o.IsAllowList,o.MACList.MACInfo){var l,r=o.MACList.MACInfo[n];if(null!=(l=datalist.getDataRowNumByMac(r.MacAddress)))datalist.list[l].MacfilterEnabled=!0,datalist.list[l].ScheduleName=r.ScheduleName,datalist.list[l].Status=!0,datalist.list[l].Live=!0;else(a=new Data(r.MacAddress,"","","LAN",decode_char_text(r.DeviceName),"","","","")).MacfilterEnabled=!0,a.ScheduleName=r.ScheduleName,a.Type="OFFLINE",a.Status=!0,datalist.push(a)}datalist.clean()}showClientLists(Client_Type),$("#Total_ConnectedClients").html(datalist.connectedLength),c.resolve()}),c.promise()}function showClientLists(e){var t=0,i='<table class="block" border="0" ondragstart="return false" onselectstart="return false" width="900px"><tbody><tr style="height:120px">';for(var s in datalist.list){var a=datalist.list[s];if("Guest"==e){if(a.Type.toLowerCase().indexOf("guest")<0)continue}else if("Host"==e){if(0<=a.Type.toLowerCase().indexOf("guest"))continue;if("Blocked"==a.Type)continue;if("New"==a.Type)continue}else if("Blocked"==e&&"Blocked"!=a.Type)continue;t++,i+=a.showClientInfo(),t%3==0&&(i+="</tr><tr>")}if(currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e){t++;i+='<td style="height:120px;"><div class ="client_add_Tag" onclick ="addData()" style ="cursor:pointer"></div></td>'}i+="</tr></tbody></table>",$("#Client_Group").html(i),0<t?$("#Client_Info").hide():"Blocked"==e||$("#Client_Info").show(),$("#Client_Group").css("display","table-row")}function addData(e){clearhometimer(),changeTimeoutAction(),$("#popTitle").html(I18N("j","Add Rule")),$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0),$("#show_Vendor").hide(),$("#client_MACAddress").hide(),$("#show_editMac").show(),$("#show_IPAdr").hide(),$("#show_IPAdrReserve").hide(),$("#enableReserveIP").prop("checked",!1),currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e?($("#show_parentcontrol").show(),$("#enableAccess").prop("checked",!1)):$("#show_parentcontrol").hide(),$("#show_Schedule").hide(),$("#editPop").show(),editType=!1,editID=""}function editData(e){clearhometimer(),changeTimeoutAction(),$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0),$("#show_Vendor").show(),$("#client_MACAddress").show(),$("#show_editMac").hide(),$("#show_IPAdr").show();var t=datalist.getData(e),i=t.IPv4Address;currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e&&(0<=t.Type.indexOf("WiFi")||"OFFLINE"==t.Type)?$("#popTitle").html(I18N("j","Edit Rule")):$("#popTitle").html(I18N("j","Edit Name")),document.getElementById("client_MACAddress").innerHTML=t.MacAddress,$("#client_Name").val(XMLDecode(t.NickName)),""==i&&(i=I18N("j","Not Available")),$("#client_IPAdr").html(i),""!=t.Vendor?document.getElementById("client_Vendor").innerHTML=t.Vendor:document.getElementById("client_Vendor").innerHTML="N/A",currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e?(t.MacfilterEnabled?($("#schedule").selectbox("detach"),$("#schedule").val(t.ScheduleName),$("#schedule").selectbox("attach"),$("#enableAccess").prop("checked",!0),$("#show_Schedule").show()):($("#schedule").selectbox("detach"),$("#schedule").val("Always"),$("#schedule").selectbox("attach"),$("#enableAccess").prop("checked",!1),$("#show_Schedule").hide()),0<=t.Type.indexOf("WiFi")||"OFFLINE"==t.Type?$("#show_parentcontrol").show():($("#show_parentcontrol").hide(),$("#show_Schedule").hide())):($("#show_parentcontrol").hide(),$("#show_Schedule").hide()),$("#editPop").show(),editType=!0,editID=e}function closeEditPOP(){$(".clientform_editPop_savetext").show(),$("#closeCreatePopBtn").hide(),$("#closeCreatePopBtn2").show(),changeTimeoutAction();$("#enableReserveIP").prop("checked"),$("#client_IPAdrReserve").val();var e=$("#client_Name").val(),t=$("#enableAccess").prop("checked"),i=$("#schedule").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0);var s=datalist.getData(editID);s.NickName=e,s.ReserveIP="",t?(currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e?s.ScheduleName=i:s.ScheduleName="",s.Status=!0,1!=s.MacfilterEnabled&&(s.MacfilterEnabled=!0)):(s.ScheduleName="",s.Status=!1,s.MacfilterEnabled=!1),datalist.editData(s.rowid,s);var a=new SOAPAction,n=new SOAPSetClientInfo,l=new SOAPClientInfo;l.MacAddress=s.MacAddress,l.NickName=encode_char_text(s.NickName),l.ReserveIP=s.ReserveIP,n.ClientInfoLists.push(l),a.sendSOAPAction("SetClientInfo",n,null).done(function(e){if(currentDevice.parentalControl_e&&currentDevice.scheduleAndWiFi_e)if("ERROR_RESERVEIP_CONFLICT"==e.SetClientInfoResult)$(".clientform_editPop_savetext").hide(),$("#closeCreatePopBtn").show(),$("#closeCreatePopBtn2").hide(),alert(I18N("j","IP address cannot be the same.")),$("#check_btn").attr("class","styled_button_s").prop("disabled",!1);else{var t=new SOAPAction,i=new SOAPSetMACFilters2;for(var s in i.IsAllowList=datalist.isAllowList,datalist.list)if(datalist.list[s].MacfilterEnabled&&"New"!=datalist.list[s].Type){var a=new SOAPMacInfo;a.DeviceName=encode_char_text(datalist.list[s].NickName),a.MacAddress=datalist.list[s].MacAddress,a.ScheduleName=datalist.list[s].ScheduleName,a.Status=datalist.list[s].Status,i.MACList.push(a)}t.sendSOAPAction("SetMACFilters2",i,null);resetRulePOP()}else resetRulePOP()}).fail(function(){resetRulePOP("close");var e=I18N("j","The new settings cannot be saved. Please try again.");PopView.showConfirm(e).done(function(){PopView.hide()})})}function closeAddPOP(){changeTimeoutAction();$("#enableReserveIP").prop("checked"),$("#client_IPAdrReserve").val();var e=$("#client_Name").val(),t=$("#enableAccess").prop("checked"),i=$("#schedule").val(),s=$("#client_editMac").val();$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0);var a=new SOAPAction,n=null;if(t){var l=new SOAPSetMACFilters2;for(var r in l.IsAllowList=datalist.isAllowList,datalist.list)if(datalist.list[r].MacfilterEnabled&&"New"!=datalist.list[r].Type){var c=new SOAPMacInfo;c.DeviceName=datalist.list[r].DeviceName,c.MacAddress=datalist.list[r].MacAddress,c.ScheduleName=encode_char_text(datalist.list[r].ScheduleName),l.MACList.push(c)}var d=new SOAPMacInfo;d.DeviceName=encode_char_text(e),d.MacAddress=s,d.Status=!0,d.ScheduleName=encode_char_text(i),l.MACList.push(d),n=a.sendSOAPAction("SetMACFilters2",l,null)}$.when(null,n).done(function(e){resetRulePOP()})}function clearCreateRulePOP(){changeTimeoutAction(),resetRulePOP("close")}function resetRulePOP(e){if($(".clientform_editPop_savetext").hide(),$("#closeCreatePopBtn").show(),$("#closeCreatePopBtn2").hide(),$("#editPop").hide(),$("input").val(""),$("#editMac_Info").hide(),$("select").selectbox("detach"),$("#schedule").val("Always"),$("select").selectbox("attach"),$("#client_IPAdrReserve_warning").remove(),$("#client_form").validate().resetForm(),$("#client_form input").removeClass("error"),"close"!=e){var t=I18N("j","Your changes are being saved, please wait...");PopView.show(t),Get_ClientInfo().always(function(){var e=I18N("j","The new settings have been saved.");PopView.showConfirm(e).done(function(){PopView.hide(),starthometimer()})})}else starthometimer()}function getClientList(e){"Host"==e?($("#client_btn_Blocked").attr("class","v4v6_linkstyle_2"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_2"),$("#client_btn_Host").attr("class","v4v6_linkstyle_1")):("Guest"==e?($("#client_btn_Blocked").attr("class","v4v6_linkstyle_2"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_1")):($("#client_btn_Blocked").attr("class","v4v6_linkstyle_1"),$("#client_btn_Guest").attr("class","v4v6_linkstyle_2")),$("#client_btn_Host").attr("class","v4v6_linkstyle_2")),Client_Type=e,Get_ClientInfo()}function buttonStyleChange(){var e=!0;changeTimeoutAction(),1==editType||(""==$("#client_editMac").val()&&(e=!1),0==$("#enableAccess").prop("checked")&&(e=!1)),1==$("#enableReserveIP").prop("checked")&&""==$("#client_IPAdrReserve").val()&&(e=!1),e?$("#check_btn").attr("class","styled_button_s").prop("disabled",!1):$("#check_btn").attr("class","styled_button_dis").prop("disabled",!0)}function setEvents(){$("#enableReserveIP").on("change",function(e){buttonStyleChange(),$(this).prop("checked")?$("#show_IPAdrReserve").show():$("#show_IPAdrReserve").hide()}),$("#enableAccess").on("change",function(e){buttonStyleChange(),$(this).prop("checked")?$("#show_Schedule").show():$("#show_Schedule").hide()}),$("#client_editMac, #client_Name, #show_IPAdrReserve").on("keyup",function(){buttonStyleChange()}),$("#schedule").on("change",function(){buttonStyleChange()})}function setClientValidate(){$.validator.addMethod("checkIP",function(e,t){return""==e||!(!COMM_ValidV4Format(e)||!COMM_ValidV4Addr(e))},jQuery.validator.messages.address_Check),$.validator.addMethod("checkMac",function(e,t){return 0!=COMM_IsMAC(e)&&("00:00:00:00:00:00"!=e&&"FF:FF:FF:FF:FF:FF"!=e.toUpperCase())},jQuery.validator.messages.mac_Check),$.validator.addMethod("checkMacConflict",function(e,t){for(var i in datalist.list){if(datalist.list[i].MacAddress.toLowerCase()==e.toLowerCase())return!1}return!0},jQuery.validator.messages.mac_Conflict),$.validator.addMethod("checkIPConflict",function(e,t){for(var i in datalist.list){var s=datalist.list[i];if((1!=editType||editID!=s.rowid)&&(""!=e&&s.ReserveIP==e))return!1}return!0},jQuery.validator.messages.ip_Conflict),$.validator.addMethod("trimWhiteSpace",function(e,t){var i=!0;return e!=e.trim()&&(i=!1),i},I18N("j","Invalid %s. Only A-Z, a-z, 0-9, “-”, “_”, and spaces are allowed.",I18N("j","Name"))),$.validator.addMethod("checkGenName",function(e,t){var i=!0;return""!=e&&(i=COMM_ValidName(e)),i},I18N("j","Invalid %s. Only A-Z, a-z, 0-9, “-”, “_”, and spaces are allowed.",I18N("j","Name"))),$("#client_form").validate({rules:{client_Name:{trimWhiteSpace:!0,checkGenName:!0},client_editMac:{checkMac:!0,checkMacConflict:!0},client_IPAdrReserve:{checkIP:!0,checkIPConflict:!0}},submitHandler:function(e){1==editType?closeEditPOP():closeAddPOP()},unhighlight:function(e,t,i){if($(e).removeClass(t).addClass(i),e==$("input#client_IPAdrReserve")[0]&&1==editType){$("#client_IPAdrReserve_warning").remove();var s=datalist.getData(editID);e.value&&e.value!=s.ReserveIP&&($(e).after("<div id='client_IPAdrReserve_warning' style='color:#00f;fone-size:12px' />"),$("#client_IPAdrReserve_warning").html(I18N("j","It will take effect after reconnecting")))}},highlight:function(e,t,i){$(e).addClass(t).removeClass(i),e==$("input#client_IPAdrReserve")[0]&&$("#client_IPAdrReserve_warning").remove()},errorPlacement:function(e,t){e.insertAfter(t).css("display","inline")}})}