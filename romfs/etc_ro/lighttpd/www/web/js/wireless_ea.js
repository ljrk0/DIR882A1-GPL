/* svn info: $Revision: 1615 $ $Date: 2019-09-03 11:55:01 +0800 (Tue, 03 Sep 2019) $ */
var RadioIDList,wifi_datalist=new Array,channelWidthSupport={band24:{},band5:{},band52:{}},channelWidthInfoListsSupport={band24:{},band5:{},band52:{}},scheduleList=[],supportSecurityModes={24:{NONE:{support:!1,order:1},OWEOROPEN:{support:!1,order:2},OWE:{support:!1,order:3},"WEP-SHARED":{support:!1,order:4},"WPA3-SAE":{support:!1,order:5},"WPA2ORWPA3-PSK":{support:!1,order:6},"WPA2-PSK":{support:!1,order:7},"WPAORWPA2-PSK":{support:!1,order:8}},5:{NONE:{support:!1,order:1},OWEOROPEN:{support:!1,order:2},OWE:{support:!1,order:3},"WEP-SHARED":{support:!1,order:4},"WPA3-SAE":{support:!1,order:5},"WPA2ORWPA3-PSK":{support:!1,order:6},"WPA2-PSK":{support:!1,order:7},"WPAORWPA2-PSK":{support:!1,order:8}}};function WiFiSetting(e,t,n){this.band=e,this.setting=t,this.security=n}function getWiFiData(e,t){for(obj in e)if(t==e[obj].band)return e[obj];return null}function RadioIDToBand(e){var t=null;switch(e){case"RADIO_2.4GHz":t="24";break;case"RADIO_5GHz":t="5"}return t}function securityToOptions(e){var t,n,i,r=[],o=supportSecurityModes[e],a=$("#APsecurity_"+e);for(t in o)1==o[t].support&&r.push([t,o[t].order]);for(r.sort(function(e,t){return e[1]-t[1]}),n=0;n<r.length;n++){switch(r[n][0]){case"NONE":i="None";break;case"OWEOROPEN":i="Enhance Open (AES/NONE)";break;case"OWE":i="Enhance Open (AES)";break;case"WEP-SHARED":i="WEP";break;case"WPA3-SAE":i="WPA3-Personal";break;case"WPA2ORWPA3-PSK":i="WPA2/WPA3-Personal";break;case"WPA2-PSK":i="WPA2-Personal";break;case"WPAORWPA2-PSK":i="WPA/WPA2-Personal"}$(a).append('<option value="'+r[n][0]+'">'+i+"</option>")}}function GetWirelessXML(){var n=$.Deferred(),i=[null,null];return InitInfo().done(function(){for(var e in RadioIDList){var t=RadioIDList[e];i[e]=get_wireless(t).then(function(e){wifi_datalist.push(e)})}$.when(i[0],i[1]).done(function(){n.resolve(wifi_datalist)})}).fail(function(){n.reject()}),n.promise()}function InitInfo(){var S=$.Deferred(),e=new SOAPAction,d=new SOAPGetWLanRadiosResponse,t=e.sendSOAPAction("GetWLanRadios",null,d);return $.when(t).done(function(){for(var e in RadioIDList=new Array,d.RadioInfos.RadioInfo){var t=d.RadioInfos.RadioInfo[e],n=t.SupportedSecurity[0].SecurityInfo,i=RadioIDToBand(t.RadioID);if(RadioIDList.push(t.RadioID),currentDevice.featureSecurityOption){for(var r=0;r<n.length;r++)supportSecurityModes[i][n[r].SecurityType.toUpperCase()]&&(supportSecurityModes[i][n[r].SecurityType.toUpperCase()].support=!0);securityToOptions(i)}for(var o=0;o<t.ChannelWidthInfoLists.ChannelWidthInfo.length;o++)for(var a=0;a<t.ChannelWidthInfoLists.ChannelWidthInfo[o].ChannelLists.length;a++){var s=channelWidthInfoListsSupport["band"+i],c=t.ChannelWidthInfoLists.ChannelWidthInfo[o].ChannelLists[a];null==s[c]&&(s[c]=new Array),s[c].push(t.ChannelWidthInfoLists.ChannelWidthInfo[o].ChannelWidth)}for(var u in t.ChannelWidthInfoLists.ChannelWidthInfo)channelWidthSupport["band"+i][t.ChannelWidthInfoLists.ChannelWidthInfo[u].ChannelWidth]=!1;"function"==typeof initChannel&&initChannel(t,i)}S.resolve()}).fail(function(){S.reject()}),S.promise()}function getSmartConnectStatus(){var t=$.Deferred(),e=new SOAPGetSmartconnectSettingsResponse;return(new SOAPAction).sendSOAPAction("GetSmartconnectSettings",null,e).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()}function get_wireless(e){var n=$.Deferred(),t=new SOAPAction,i=new SOAPGetWLanRadioSettings,r=new SOAPGetWLanRadioSecurity,o=new SOAPGetWLanRadioSettingsResponse,a=new SOAPGetWLanRadioSecurityResponse,s=RadioIDToBand(e);i.RadioID=e;var c=t.sendSOAPAction("GetWLanRadioSettings",i,o);r.RadioID=e;var u=t.sendSOAPAction("GetWLanRadioSecurity",r,a);return $.when(c,u).done(function(e){var t=new WiFiSetting(s,o,a);n.resolve(t)}).fail(function(e){n.reject()}),n.promise()}function getOPmode(){var t=$.Deferred(),e=new SOAPAction,n=new SOAPGetOperationModeResponse;return e.sendSOAPAction("GetOperationMode",null,n).done(function(e){t.resolve(e)}).fail(function(e){t.reject()}),t.promise()}function getAPCsettings(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPGetAPClientSettings,r=new SOAPGetAPClientSettingsResponse;return i.RadioID=e,n.sendSOAPAction("GetAPClientSettings",i,r).done(function(e){"true"==e.Enabled.toLowerCase()&&""!=e.SSID?t.resolve(e):t.reject(e)}).fail(function(e){t.reject()}),t.promise()}function getAPCinfoByRadio(e,t){var n=$.Deferred(),i=t;return getAPCsettings(e[i]).done(function(e){n.resolve(e)}).fail(function(){++i<e.length?getAPCinfoByRadio(e,i).done(function(e){n.resolve(e)}).fail(function(){n.reject()}):n.reject()}),n.promise()}function getAPCinfo(e){var t=$.Deferred();return getAPCinfoByRadio(e,0).done(function(e){t.resolve(e)}).fail(function(){var e=new SOAPGetAPClientSettingsResponse;t.resolve(e)}),t.promise()}function createWlanSettings(e){var t=new SOAPSetWLanRadioSettings,n=getWiFiData(wifi_datalist,e),i=$("#CurrentOPMode").val(),r=$("#APenabled_Smart").prop("checked");switch(e){case"24":t.RadioID="RADIO_2.4GHz",t.Coexistence=$("#APcoexistence_"+e).prop("checked"),t.Mode="802.11bgn";break;case"5":t.RadioID="RADIO_5GHz",t.Mode="802.11anac",t.Coexistence=n.setting.Coexistence}return r?(t.Enabled=$("#APenabled_24").prop("checked"),t.SSID=XMLEncode($("#APssid_24").val()),t.ChannelWidth=n.setting.ChannelWidth,t.Channel=n.setting.Channel):(t.Enabled=$("#APenabled_"+e).prop("checked"),t.SSID=XMLEncode($("#APssid_"+e).val()),"WirelessAp"==i?(t.ChannelWidth=$("#APchannelWidth_"+e).val(),t.Channel=$("#APchannel_"+e).val()):(t.ChannelWidth=n.setting.ChannelWidth,t.Channel=n.setting.Channel)),t.SSIDBroadcast=n.setting.SSIDBroadcast,t.QoS=n.setting.QoS,currentDevice.scheduleAndWiFi_ea?currentDevice.featureWirelessSchedule?t.ScheduleName=r?$('input[name="scheduleRadio_24"]:checked').val():$('input[name="scheduleRadio_'+e+'"]:checked').val():t.ScheduleName=r?$("#schedule_24").val():$("#schedule_"+e).val():t.ScheduleName=n.setting.ScheduleName,t.TXPower=n.setting.TXPower,t.MUMIMOEnabled=n.setting.MUMIMOEnabled,t.BandSteeringEnabled=r,t.AirTimeFairnessEnabled=n.setting.AirTimeFairnessEnabled,t}function createWlanSecurity(e){var t=new SOAPSetWLanRadioSecurity,n=$("#APenabled_Smart").prop("checked"),i=$("#APkey_"+e).val(),r=$("#APsecurity_"+e).val(),o="";switch(e){case"24":t.RadioID="RADIO_2.4GHz";break;case"5":t.RadioID="RADIO_5GHz"}return n&&(i=$("#APkey_24").val(),r=$("#APsecurity_24").val()),0==i.length?(t.Enabled=!1,t.Type="NONE",t.Encryption="NONE"):(t.Enabled=!0,t.KeyRenewal=3600,t.Key=i,currentDevice.featureSecurityOption?("WEP-SHARED"==r?5==i.length||10==i.length?o="WEP-64":13!=i.length&&26!=i.length||(o="WEP-128"):o="OWE"==r||"OWEOROPEN"==r||"WPA3-SAE"==r||"WPA2ORWPA3-PSK"==r?"AES":"TKIPORAES",t.Type=r,t.Encryption=o):(t.Type="WPAORWPA2-PSK",t.Encryption="TKIPORAES")),t}function createOPmode(e,t){var n=new SOAPSetOperationMode;return n.RadioID=e,n.CurrentOPMode=t,n}function createAPCSettings(e,t){var n=XMLEncode(e),i=t,r=new SOAPSetAPClientSettings;return r.RadioID="",r.SSID=n,r.Enabled=!0,0==(r.Key=i).length?(r.SupportedSecurity.SecurityInfo[0].SecurityType="NONE",r.SupportedSecurity.SecurityInfo[0].Encryptions=["NONE"]):(r.SupportedSecurity.SecurityInfo[0].SecurityType="WPAORWPA2-PSK",r.SupportedSecurity.SecurityInfo[0].Encryptions=["TKIPORAES"]),r}function SetWirelessXML(){var e,t,n=$.Deferred(),i=new SOAPAction,r=$("#CurrentOPMode").val();for(var o in RadioIDList){e=createOPmode(RadioIDList[o],r),i.SetMultipleSOAP("SetOperationMode",e,null)}if("WirelessAp"!=r&&(e=createAPCSettings($("#APCssid").val(),$("#APCkey").val()),i.SetMultipleSOAP("SetAPClientSettings",e,null),count=80),setSmartConnectStatus(i,$("#APenabled_Smart").prop("checked")),currentDevice.featureWirelessSchedule){var a=spDropDownListDatalist.setScheduleXML(),s="SetScheduleSettings";currentDevice.featureBitMapSchedule&&(s="SetScheduleBitmapSettings"),i.SetMultipleSOAP(s,a,null)}for(var o in RadioIDList){var c=RadioIDToBand(RadioIDList[o]);e=createWlanSettings(c),i.SetMultipleSOAP("SetWLanRadioSettings",e,null),t=createWlanSecurity(c),i.SetMultipleSOAP("SetWLanRadioSecurity",t,null)}return i.SendMultipleSOAPAction("SetMultipleActions").done(function(){n.resolve()}),n.promise()}function setSmartConnectStatus(e,t){var n=new SOAPSetSmartconnectSettings;n.Enabled=t,e.SetMultipleSOAP("SetSmartconnectSettings",n,null)}function startWPSPBC(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPSetTriggerWPS,r=new SOAPSetTriggerWPSResponse;return stopTimeout(),i.Duration=e,n.sendSOAPAction("SetTriggerWPS",i,r).done(function(e){getWPSStatus(1e3*parseInt(e.WaitTime)).progress(function(e){t.notify(e)}).then(function(e){startTimeout(),t.resolve(e)}).fail(function(){t.reject()})}).fail(function(e){t.reject()}),t.promise()}function getWPSStatus(e){var i=$.Deferred(),t=new SOAPAction,n=new SOAPGetWPSStatusResponse,r=setTimeout(function(){r=setInterval(function(){t.sendSOAPAction("GetWPSStatus",null,n).done(function(e){for(var t in e.WPSStatusLists.WPSStatus){var n=e.WPSStatusLists.WPSStatus[t];if("WPS_IN_PROGRESS"==n.Status.toUpperCase())break;"WPS_SUCCESS"==n.Status.toUpperCase()?(clearInterval(r),i.resolve(n)):(clearInterval(r),i.reject())}}).fail(function(e){clearInterval(r),i.reject()})},2e3),i.notify(r)},e);return i.notify(r),i.promise()}function getSiteSurveyResult(e){var t=$.Deferred(),n=new SOAPAction,i=new SOAPGetSiteSurvey,r=new SOAPGetSiteSurveyResponse;return i.RadioID=e,n.sendSOAPAction("GetSiteSurvey",i,r).done(function(e){t.resolve(e)}).fail(function(){t.reject()}),t.promise()}function doSiteSurveyByRadio(i,e){var r=$.Deferred(),o=e,t=new SOAPAction,n=new SOAPSetTriggerWirelessSiteSurvey,a=new SOAPSetTriggerWirelessSiteSurveyResponse;n.RadioID=i[o],t.sendSOAPAction("SetTriggerWirelessSiteSurvey",n,a).done(function(e){var t=parseInt(e.WaitTime);sleep(1e3*t).then(function(){return getSiteSurveyResult(i[o])}).then(function(e){var t=e.APStatInfoLists.APStatInfo;for(var n in t)t[n].radioID=i[o];r.notify(t),s(!0)}).fail(function(){s(!1)})}).fail(function(){r.reject()});var s=function(e){++o<i.length?doSiteSurveyByRadio(i,o).done(function(e){r.resolve()}).progress(function(e){r.notify(e)}).fail(function(){r.reject()}):e?r.resolve():r.reject()};return r.promise()}function sortSiteList(e){e.sort(function(e,t){return parseInt(t.SignalStrength)-parseInt(e.SignalStrength)})}function doSiteSurvey(){var e=$.Deferred(),n=new Array;return stopTimeout(),doSiteSurveyByRadio(RadioIDList,0).progress(function(e){for(var t in e)n.push(e[t])}).always(function(){sortSiteList(n),startTimeout(),e.resolve(n)}),e.promise()}function getschedulesettings(){var e,t=$.Deferred(),n=new SOAPAction,o=new SOAPGetScheduleSettingsResponse,i={page:"wireless",timeFormat:currentDevice.featureScheduleRuleSlotInterval};return currentDevice.featureBitMapSchedule?(o=new SOAPGetScheduleBitmapSettingsResponse,i.hnapName="GetScheduleBitmapSettings",e=n.sendSOAPAction("GetScheduleBitmapSettings",null,o)):e=n.sendSOAPAction("GetScheduleSettings",null,o),currentDevice.featureWirelessSchedule?$.when(e).done(function(){scheduleList.push($("#scheduleDrop_24").spDropDownList({titleWidth:293.328,contextWidth:293.328,elName:"H24-UH1xLTJa7O"})),scheduleList.push($("#scheduleDrop_5").spDropDownList({titleWidth:293.328,contextWidth:293.328,elName:"H5-UH1xLTJa7O"})),scheduleSelectableUI.init(i).getData(o),t.resolve()}).fail(function(){t.reject()}):$.when(e).done(function(){RadioIDList.map(function(e){var t=RadioIDToBand(e),n=$("#schedule_"+t);for(var i in n.append('<option value="Always">'+I18N("j","Always")+"</option>"),o.ScheduleInfoLists){var r=o.ScheduleInfoLists[i].ScheduleName;n.append('<option value="'+r+'">'+decode_char_text(r)+"</option>")}n.selectbox({width:"100%"})}),t.resolve()}).fail(function(){t.reject()}),t.promise()}